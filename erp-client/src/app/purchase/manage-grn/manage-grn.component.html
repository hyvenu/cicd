



<div class="form-row">
    <a nbButton [routerLink]="['/GrnList']" status="success" size="small">Back to GRN List</a>
</div>

<nb-tabset>
    <nb-tab tabTitle="GRN Information" [active]="IsGrnInfo">

        <form id="" [formGroup]="grnMasterForm" (keydown.enter)="$event.preventDefault()" (ngSubmit)=onSubmit()>
            <div class="form-row">
                <div class="form-group col-md-3">
                    <label for="grnNumber">GRN Number </label>
                    <input nbInput formControlName="grnNumberFormControl" name="grnNumber" placeholder="Auto Generated"
                        [readonly]="true" />
                </div>
                <div class="form-group col-md-3">
                    <label for="grnDate">GRN Date<span style="color: red;">*</span></label>
                    <input nbInput formControlName="grnDateFormControl" id="grnDate" name="grnDate" [nbDatepicker]="datepicker" (ngModelChange)="onChange(datepicker.value)"
                        placeholder="GRN Date" #date1   [ngClass]="{ 'is-invalid': submitted && f.grnDateFormControl.errors }" class=" form-control"/>
                        <div *ngIf="submitted && f.grnDateFormControl.errors" class="invalid-feedback">
                            <div *ngIf="f.grnDateFormControl.errors.required">GRN Date is required</div>
                        </div> 
                    <nb-datepicker format="yyyy-MM-DD"  #datepicker></nb-datepicker>
                </div>
                <div class="form-group col-md-3">
                    <label for="invoiceDate">Invoice Date<span style="color: red;">*</span></label>
                    <input nbInput formControlName="invoiceDateFormControl" id="invoiceDate" name="InvoiceDate"
                        [nbDatepicker]="invoicedatepicker"  placeholder="Invoice Date"
                        [ngClass]="{ 'is-invalid': submitted && f.invoiceDateFormControl.errors }" class=" form-control"/>
                        <div *ngIf="submitted && f.invoiceDateFormControl.errors" class="invalid-feedback">
                            <div *ngIf="f.invoiceDateFormControl.errors.required">Invoice Date is required</div>
                        </div> 
                    <nb-datepicker format="yyyy-MM-DD"  #invoicedatepicker></nb-datepicker>
                </div>
             
            </div><br>

            <script>
                
                var down = document.getElementById('geeks');
           function gfg() {
               var grndate = 
                   document.getElementById('grnDate').value;
               var indate = 
                   document.getElementById('invoiceDate').value;  
               var Gdate = new Date(grndate);
               var Idate = new Date(indate);
                 
               if(Gdate.setHours(0, 0, 0, 0) <= 
                       Idate.setHours(0, 0, 0, 0))
               {
                   down.innerHTML = 
                       "The input date Cannot be less than GRN Date ";
               } 
                    
           }
       </script>
            <div class="form-row">
                <div class="form-group col-md-3">
                    <label for="invoiceNumber">Invoice Number<span style="color: red;">*</span> </label>
                    <input nbInput  (keypress)="date_check()" formControlName="invoiceNumberFormControl" name="invoiceNumber"
                        placeholder="Invoice Number" [ngClass]="{ 'is-invalid': submitted && f.invoiceNumberFormControl.errors }" class=" form-control"/>
                        <div *ngIf="submitted && f.invoiceNumberFormControl.errors" class="invalid-feedback">
                            <div *ngIf="f.invoiceNumberFormControl.errors.required">PO Number is required</div>
                        </div> 
                </div>
                <div class="form-group col-md-3">
                    <label for="poNumber">PO Number<span style="color: red;">*</span></label>
                    <input nbInput formControlName="poNumberFormControl" name="poNumber" placeholder="PO Number"
                        (keypress)="po_open(dialog)"    (click)="po_open(dialog)" readonly [ngClass]="{ 'is-invalid': submitted && f.poNumberFormControl.errors }" class=" form-control"/>
                        <div *ngIf="submitted && f.poNumberFormControl.errors" class="invalid-feedback">
                            <div *ngIf="f.poNumberFormControl.errors.required">PO Number is required</div>
                        </div> 
                    <!-- <input nbInput formControlName="prNumberFormControl" name="pr_number" placeholder="pr_number"  /> -->
                </div>
           
            </div><br>
            <p id = "geeks" ></p>

            <div class="form-row">
                <div class="form-group col-md-3">
                    <label for="vendorName">Vendor Name <span style="color: red;">*</span></label>
                    <input nbInput formControlName="vendorNameFormControl" name="vendorName"
                        placeholder="Vendor Name" readonly />
                </div>
                <div class="form-group col-md-3">
                    <label for="vendorAddress">Vendor Address <span style="color: red;">*</span></label>
                    <textarea nbInput formControlName="vendorAddressFormControl" name="corporateOffice"
                        placeholder="Vendor Address" readonly></textarea>
                </div>
            </div><br>

            <nb-card accent="info">
                <nb-card-header>
                    <b><u>Transportation Details</u>&nbsp; </b>
                </nb-card-header>
                <nb-card-body>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="vehicleNumber">Vehicle Number</label>
                            <input nbInput formControlName="vehicleNumberFormControl" name="vehicleNumber"
                                placeholder="Vehicle Number" />
                        </div>
                        <div class="form-group col-md-4">
                            <label for="timeIn">Time In </label> <br>
                            <input type="time" nbInput formControlName="timeInFormControl" name="timeIn" value=""
                                placeholder="Time In" />
                        </div>
                        <div class="form-group col-md-4">
                            <label for="timeOut">Time Out </label> <br>

                            <input type="time" nbInput formControlName="timeOutFormControl" name="timeOut" value=""
                                placeholder="Time Out" />
                        </div>
                    </div><br>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="transporterName"> Transporter Name</label>
                            <input nbInput formControlName="transporterNameFormControl" name="Transporter Name"
                                placeholder="Transporter Name" />
                        </div>
                        <div class="form-group col-md-4">
                            <label for="statutoryDetails">Statutory Details </label>
                            <input nbInput formControlName="statutoryDetailsFormControl" name="statutoryDetails"
                                placeholder="Statutory Details" />
                        </div>
                        <div class="form-group col-md-4">
                            <label for="note">Note </label><br>
                            <textarea nbInput formControlName="noteFormControl" name="note" value=""
                                placeholder="Note"></textarea>
                        </div>
                    </div><br>

                </nb-card-body>
            </nb-card>
            <nb-card accent="info">
                <nb-card-header>
                    <b><u>Products</u>&nbsp; </b>
                </nb-card-header>
                <nb-card-body>

                    <table class="table table-hovered">
                        <thead>
                            <!-- <th></th> -->
                            <th>Sl.No.</th>
                            <th>Product Code</th>
                            <th>Product Name</th>
                            <th>HSN</th>
                            <th>Quantity Received</th>
                            <th>Rejected Quantity</th>
                            <th>Accepted Quantity</th>
                            <th>Unit</th>
                            <th>PO Quantity</th>
                            <th>Unit Price</th>
                            <th>Total Amount</th>
                            <th>Item Description</th>
                            <th>GST %</th>
                            <th>GST Amount</th>
                            <th>Total </th>
                            <th>Batch</th>
                            <th>Expiry date</th>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of selected_product_list; let i=index" [class.hidden]="!item.active">
                                <!-- <td><button nbButton (click)="delete(item);" status="danger" size="small"
                                        *ngIf="pr_status!='APPROVED' && pr_status!='REJECTED'">X</button><br></td> -->
                                <td><input nbInput placeholder=""  value={{i+1}} readonly/></td>
                                <td><input nbInput placeholder=""  value={{item.product_code}} readonly /></td>
                                <td><input nbInput placeholder=""  value={{item.product_name}} readonly /></td>
                                <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}" [(ngModel)]="item.hsn_code"  readonly/></td>
                                <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}"  [(ngModel)]="item.received_qty" (change)="calculate(item);"  readonly/></td>
                                <td><input type="number"  oninput="validity.valid || (value='')" nbInput placeholder="" [ngModelOptions]="{standalone: true}" min="0" [max]="item.received_qty" [(ngModel)]="item.rejected_qty" (change)="calculate(item);" /></td>
                                <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}" [(ngModel)]="item.accepted_qty" (change)="calculate(item);" readonly/></td>
                                <!-- <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}" [(ngModel)]="item.unit_id" (change)="calculate(item);" /></td> -->
                                <td ><nb-select class="from-control btn-sm" name="item.unit"  [(selected)]="item.unit_id">
                                    <nb-option *ngFor="let o of unit_list" value="{{o.id}}">
                                        {{ o.PrimaryUnit }}
                                    </nb-option>
                                </nb-select></td>
                                
                                <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}" [(ngModel)]="item.po_qty" readonly (change)="calculate(item);" /></td>
                                <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}" [(ngModel)]="item.unit_price" readonly (change)="calculate(item);" /></td>
                                <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}" [(ngModel)]="item.amount" readonly (change)="calculate(item);" /></td>
                                <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}" [(ngModel)]="item.description" readonly /></td>
                                <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}" [(ngModel)]="item.gst" readonly (change)="calculate(item);" /></td>
                                <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}" [(ngModel)]="item.gst_amount" readonly (change)="calculate(item);" /></td>
                                <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}" [(ngModel)]="item.total" readonly (change)="calculate(item);" /></td>
                                <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}" [(ngModel)]="item.batch_code" /></td>
                                <!-- <td><input nbInput placeholder="" [ngModelOptions]="{standalone: true}" [(ngModel)]="item.expiry_date" /></td> -->
                                <td><input nbInput [ngModelOptions]="{standalone: true}" [(ngModel)]="item.expiry_date" (ngModelChange)="onChanges(datepicker.value,item.expiry_date)" #date [nbDatepicker]="expiry_date_datepicker"
                                    placeholder="Date" />
                                    <!-- <input [nbDatepicker]="datepicker"> -->
                                    <nb-datepicker format="yyyy-MM-DD"  #expiry_date_datepicker></nb-datepicker>
                                    </td>
                            </tr>
                        </tbody>
                    </table>
                </nb-card-body>
                <nb-card-footer>
                    <table class="table table-hovered">
                        <thead style="font-size: smaller;" >
                            <th>Sub Total Amount</th>
                            <th></th>
                            <!-- <th>Total Order Value</th> -->
                            <th>SGST</th>
                            <th>CGST</th>
                            <th>IGST</th>
                            <th>Grand Total</th>
                        </thead>
                        <tbody>
                            <tr>
                                <td> {{ sub_total | currency:'INR' }}</td>
                                <td></td>
                                <td> {{ sgst | currency : 'INR' }}  </td>
                                <td> {{ cgst | currency : 'INR' }} </td>
                                <td> {{ igst | currency : 'INR' }} </td>
                                <td> {{ grand_total  | currency : 'INR'}} </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="invoiceDocument">Upload Invoice</label>
                            <input type="file" formControlName="invoiceDocumentFormControl" multiple
                                (change)="onFileChange($event, 'image');" />
                        </div>
                        <div class=" form-group col-md-4">
                            <img  src="{{imgSrc}}" class="rounded" alt="No Image"  width="80" height="80" *ngIf="imgSrc && !DocFileExist"/>
                            
                            <a href="{{imgSrc}}"  download="GRN-Doc" >
                                <label *ngIf="DocFileExist">{{FileName1}}</label><br>
                                <input type="button" value="Download" *ngIf="DocFileExist" >
                            </a>
                        </div>
                    </div><br>
                    <button nbButton (click)="saveGRN();" status="success" >Save</button>
                </nb-card-footer>   
            </nb-card>
        </form>
    </nb-tab>
</nb-tabset>

<ng-template #dialog let-data let-ref="dialogRef">
    <nb-card size="large">
        <nb-card-header>PO List <input type="text" nbInput size="small" placeholder="Search .."
                [(ngModel)]="searchPO" /> </nb-card-header>
        <nb-card-body>
            <nb-list>
                <nb-list-item *ngFor="let item of data| search_filter:'po_number':searchPO">
                    <i class="mr-auto mt-2 mt-lg-0">{{ item.po_number }} </i>
                    <button nbButton (click)="ref.close(item)" size="small">Select</button>
                </nb-list-item>
            </nb-list>
        </nb-card-body>
        <nb-card-footer>
            <button nbButton (click)="ref.close()">Close</button>
        </nb-card-footer>
    </nb-card>
</ng-template>